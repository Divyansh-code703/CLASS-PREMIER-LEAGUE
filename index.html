<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Class Premier League — Phase 1</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrap">

    <!-- header / logo -->
    <header class="top">
      <img class="ipl-logo" src="https://upload.wikimedia.org/wikipedia/en/d/d7/IPL_2022_Logo.png" alt="CPL Logo">
      <h1>Class Premier League (CPL)</h1>
    </header>

    <!-- AUTH -->
    <section id="auth" class="card">
      <h2>Sign Up / Login</h2>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password (min 6)" />
      <div class="row">
        <button id="signupBtn" class="primary">Sign Up</button>
        <button id="loginBtn">Login</button>
      </div>
      <div class="muted">Already registered? Login. First time? Sign up & choose your team.</div>
    </section>

    <!-- TEAM SELECTION -->
    <section id="team-select" class="card hidden">
      <h2>Select Your Team</h2>
      <div class="teams-grid" id="teamsGrid"></div>
      <div class="row">
        <button id="chooseTeamBtn" class="primary" disabled>Confirm Team</button>
      </div>
      <div class="muted">Once a team is chosen, it will be reserved for your account.</div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="card hidden">
      <h2>Welcome, <span id="userEmail"></span></h2>
      <div class="info">
        <div><strong>Your Team:</strong> <span id="yourTeam">—</span></div>
        <div><strong>Purse Left:</strong> <span id="yourPurse">₹150.00 Cr</span></div>
      </div>
      <div class="row">
        <button id="goAuction" class="primary" disabled>Go to Auction (coming next)</button>
        <button id="signoutBtn">Sign out</button>
      </div>
      <div class="muted">If you want to change team later, use the Manage Squad after auction.</div>
    </section>

    <footer class="footer muted">Phase 1 — Login & Team Selection</footer>
  </div>

  <!-- ✅ Working Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdpxNsLzKNeZ9MhQqU_T_oLdg-hCoXzSk",
      authDomain: "class-premier-league.firebaseapp.com",
      projectId: "class-premier-league",
      storageBucket: "class-premier-league.firebasestorage.app",
      messagingSenderId: "59210532535",
      appId: "1:59210532535:web:4558b69e94949b65cc6f32"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authSection = document.getElementById("auth");
    const teamSelectSection = document.getElementById("team-select");
    const dashboardSection = document.getElementById("dashboard");

    const emailInput = document.getElementById("email");
    const passInput = document.getElementById("password");
    const signupBtn = document.getElementById("signupBtn");
    const loginBtn = document.getElementById("loginBtn");
    const signoutBtn = document.getElementById("signoutBtn");

    const teamsGrid = document.getElementById("teamsGrid");
    const chooseTeamBtn = document.getElementById("chooseTeamBtn");
    const userEmailSpan = document.getElementById("userEmail");
    const yourTeamSpan = document.getElementById("yourTeam");
    const yourPurseSpan = document.getElementById("yourPurse");

    const TEAMS = [
      { code: "RCB", name: "Royal Challengers Bengaluru", logo: "https://upload.wikimedia.org/wikipedia/en/0/0b/Royal_Challengers_Bengaluru_Logo.svg" },
      { code: "CSK", name: "Chennai Super Kings", logo: "https://upload.wikimedia.org/wikipedia/en/9/9d/Chennai_Super_Kings_Logo.svg" },
      { code: "MI",  name: "Mumbai Indians", logo: "https://upload.wikimedia.org/wikipedia/en/3/3d/Mumbai_Indians_Logo.svg" },
      { code: "LSG", name: "Lucknow Super Giants", logo: "https://upload.wikimedia.org/wikipedia/en/8/8b/Lucknow_Super_Giants_Logo.svg" },
      { code: "PBKS",name: "Punjab Kings", logo: "https://upload.wikimedia.org/wikipedia/en/1/1b/Punjab_Kings_Logo.svg" },
      { code: "SRH", name: "Sunrisers Hyderabad", logo: "https://upload.wikimedia.org/wikipedia/en/1/19/Sunrisers_Hyderabad_Logo.svg" }
    ];

    const START_PURSE_LAKHS = 15000;

    function showSection(sec){
      authSection.classList.add("hidden");
      teamSelectSection.classList.add("hidden");
      dashboardSection.classList.add("hidden");
      sec.classList.remove("hidden");
    }

    function lakhToStr(l){
      if(l >= 100) return "₹" + (l/100).toFixed(2) + " Cr";
      return "₹" + l.toFixed(2) + " L";
    }

    async function renderTeamsGrid(){
      teamsGrid.innerHTML = "";
      const taken = new Set();
      try{
        const usersCol = collection(db, "users");
        const snap = await getDocs(usersCol);
        snap.forEach(d=> { const u = d.data(); if(u.team) taken.add(u.team); });
      }catch(e){ console.warn(e); }

      TEAMS.forEach(t=>{
        const div = document.createElement("div");
        div.className = "team-card";
        const isTaken = taken.has(t.code);
        div.innerHTML = `<img src="${t.logo}" alt="${t.code}"><div class="meta"><div class="name">${t.name}</div><div class="code">${t.code} ${isTaken? "— (Taken)": ""}</div></div>`;
        if(isTaken) div.style.opacity = "0.55";
        div.addEventListener("click", ()=>{
          if(isTaken) return alert("Sorry — this team is already taken.");
          document.querySelectorAll(".team-card").forEach(c=>c.classList.remove("selected"));
          div.classList.add("selected");
          selectedTeamCode = t.code;
          chooseTeamBtn.disabled = false;
        });
        teamsGrid.appendChild(div);
      });
    }

    let selectedTeamCode = null;

    signupBtn.addEventListener("click", async ()=>{
      const email = emailInput.value.trim();
      const pass = passInput.value;
      if(!email || pass.length < 6) return alert("Enter valid email & password (min 6 chars)");
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;
        await setDoc(doc(db, "users", uid), {
          uid, email, team: null, purse: START_PURSE_LAKHS, players: []
        });
        alert("✅ Sign up successful — now choose your team.");
        await renderTeamsGrid();
        showSection(teamSelectSection);
      }catch(err){
        alert("❌ " + err.message);
      }
    });

    loginBtn.addEventListener("click", async ()=>{
      const email = emailInput.value.trim();
      const pass = passInput.value;
      if(!email || pass.length < 6) return alert("Enter valid email & password (min 6 chars)");
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        alert("✅ Logged in successfully!");
      }catch(err){ alert("❌ " + err.message); }
    });

    signoutBtn?.addEventListener("click", async ()=>{
      await signOut(auth);
      alert("Logged out.");
      showSection(authSection);
    });

    chooseTeamBtn.addEventListener("click", async ()=>{
      if(!selectedTeamCode) return alert("Select a team first!");
      const user = auth.currentUser;
      if(!user) return alert("Login first");
      const uid = user.uid;
      const userRef = doc(db, "users", uid);
      const q = query(collection(db, "users"), where("team", "==", selectedTeamCode));
      const qSnap = await getDocs(q);
      if(!qSnap.empty) return alert("Someone just took this team!");
      await updateDoc(userRef, { team: selectedTeamCode });
      alert("✅ Team selected: " + selectedTeamCode);
      loadDashboard(uid);
    });

    async function loadDashboard(uid){
      const uDoc = await getDoc(doc(db, "users", uid));
      if(!uDoc.exists()) return;
      const u = uDoc.data();
      userEmailSpan.textContent = u.email;
      yourTeamSpan.textContent = u.team || "No team yet";
      yourPurseSpan.textContent = lakhToStr(u.purse);
      if(u.team) showSection(dashboardSection);
      else { await renderTeamsGrid(); showSection(teamSelectSection); }
    }

    onAuthStateChanged(auth, async (user)=>{
      if(user){ await loadDashboard(user.uid); }
      else showSection(authSection);
    });
  </script>
</body>
                     </html>
